<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MineBoard - Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Update Banner -->
        <div id="updateBanner" class="update-banner" style="display:none;">
            <div class="update-banner-content">
                <div class="flex items-center gap-3">
                    <i class="fas fa-download text-lg"></i>
                    <div class="update-banner-text">
                        <div class="font-semibold">Nuova versione disponibile: <span id="latestVersionText"></span></div>
                        <div class="text-sm text-tertiary">Versione installata: <span id="currentVersionText"></span></div>
                    </div>
                </div>
                <div class="update-banner-actions">
                    <a id="updateLink" class="btn btn-warning" href="#" target="_blank" rel="noopener noreferrer">
                        <i class="fas fa-external-link-alt"></i> Scarica
                    </a>
                    <button id="updateNowBtn" class="btn btn-success">
                        <i class="fas fa-bolt"></i> Aggiorna
                    </button>
                    <button id="dismissUpdate" class="btn btn-ghost">
                        <i class="fas fa-times"></i> Nascondi
                    </button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <div>
                        <h1><i class="fas fa-cube"></i> MineBoard</h1>
                        <p>Complete Minecraft server management dashboard</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="theme-switcher">
                        <input type="checkbox" id="theme-toggle">
                        <label for="theme-toggle">
                            <i class="fas fa-moon"></i>
                            <i class="fas fa-sun"></i>
                        </label>
                    </div>
                    {% if permissions.settings_access %}
                    <a href="/settings/users" class="btn btn-ghost" title="Impostazioni">
                        <i class="fas fa-cog"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- System Statistics -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-chart-line"></i>
                    <h2>System Statistics</h2>
                </div>
                <button class="btn btn-ghost" onclick="refreshStats()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
            
            <div class="stats-grid" id="systemStats">
                <div class="stat-card">
                    <div class="stat-value">--</div>
                    <div class="stat-label">CPU Usage</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">--</div>
                    <div class="stat-label">Memory Usage</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">--</div>
                    <div class="stat-label">Disk Usage</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-bolt"></i>
                    <h2>Quick Actions</h2>
                </div>
            </div>
            
            <div class="flex gap-3" style="flex-wrap: wrap;">
                <a href="/servers" class="btn btn-primary">
                    <i class="fas fa-server"></i> Manage Servers
                </a>
                <a href="/servers/new" class="btn btn-success">
                    <i class="fas fa-plus"></i> Create Server
                </a>
                {% if permissions.settings_access %}
                <a href="/settings/users" class="btn btn-secondary">
                    <i class="fas fa-users-cog"></i> User Settings
                </a>
                {% endif %}
                <a href="/logout" class="btn btn-warning">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>

        <!-- Active Servers -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-play-circle"></i>
                    <h2>Active Servers</h2>
                </div>
            </div>
            
            <div id="activeServers">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <span>Loading active servers...</span>
                </div>
            </div>
        </div>

        <!-- All Servers -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-list"></i>
                    <h2>All Servers</h2>
                </div>
                <a href="/servers" class="btn btn-secondary">
                    <i class="fas fa-external-link-alt"></i> View All
                </a>
            </div>

            <div id="allServers">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <span>Loading servers...</span>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-info-circle"></i>
                    <h2>System Information</h2>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px;">
                <div>
                    <h3 class="flex items-center gap-2 mb-4 font-semibold text-lg">
                        <i class="fas fa-server text-primary-500"></i> Web Server
                    </h3>
                    <div class="text-secondary">
                        <p>MineBoard Dashboard</p>
                        <p>Port: 8999</p>
                        <p>Python Flask</p>
                    </div>
                </div>
                <div>
                    <h3 class="flex items-center gap-2 mb-4 font-semibold text-lg">
                        <i class="fas fa-folder text-primary-500"></i> Directories
                    </h3>
                    <div class="text-secondary">
                        <p>Servers: ./servers/</p>
                        <p>Logs: ./logs/</p>
                        <p>Uploads: ./uploads/</p>
                    </div>
                </div>
                <div>
                    <h3 class="flex items-center gap-2 mb-4 font-semibold text-lg">
                        <i class="fas fa-cog text-primary-500"></i> Features
                    </h3>
                    <div class="text-secondary">
                        <p>Multi-server management</p>
                        <p>Real-time console</p>
                        <p>File management</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification"></div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
        // Load system stats
        async function loadSystemStats() {
            try {
                const data = await apiCall('/api/system/stats');
                if (data.success) {
                    updateSystemStats(data.stats);
                }
            } catch (error) {
                console.error('Error loading system stats:', error);
            }
        }

        // Load all servers
        async function loadAllServers() {
            try {
                const data = await apiCall('/api/servers');
                const container = document.getElementById('allServers');

                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-server"></i>
                            <h3>No servers found</h3>
                            <p>Create your first Minecraft server to get started</p>
                            <a href="/servers/new" class="btn btn-success">
                                <i class="fas fa-plus"></i> Create First Server
                            </a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="server-grid">
                        ${data.map(server => `
                            <div class="server-item">
                                <div class="server-header">
                                    <div class="server-info">
                                        <h3>${server.name}</h3>
                                        <div class="server-meta">
                                            <span><i class="fas fa-plug"></i> Port: ${server.port}</span>
                                            <span><i class="fas fa-memory"></i> RAM: ${server.max_memory}</span>
                                            <span><i class="fas fa-file-archive"></i> ${server.jar_file}</span>
                                        </div>
                                    </div>
                                    <div class="status-badge ${server.status === 'running' ? 'status-running' : 'status-stopped'}">
                                        ${server.status === 'running' ? 'Running' : 'Stopped'}
                                    </div>
                                </div>
                                <div class="server-actions">
                                    <a href="/servers/${server.name}" class="btn btn-primary">
                                        <i class="fas fa-cog"></i> Manage
                                    </a>
                                    ${server.status === 'running' ?
                                        `<button class="btn btn-danger" onclick="stopServerFromDashboard('${server.name}')">
                                            <i class="fas fa-stop"></i> Stop
                                        </button>` :
                                        `<button class="btn btn-success" onclick="startServerFromDashboard('${server.name}')">
                                            <i class="fas fa-play"></i> Start
                                        </button>`
                                    }
                                    <button class="btn btn-warning" onclick="restartServerFromDashboard('${server.name}')">
                                        <i class="fas fa-redo"></i> Restart
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                document.getElementById('allServers').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="color: var(--danger-500);"></i>
                        <h3>Error loading servers</h3>
                        <p>Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        // Server actions from dashboard
        async function startServerFromDashboard(serverName) {
            try {
                const data = await apiCall(`/api/servers/${serverName}/start`, { method: 'POST' });
                showNotification(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    loadActiveServers();
                    loadAllServers();
                }
            } catch (e) {
                showNotification('Error starting server', 'error');
            }
        }

        async function stopServerFromDashboard(serverName) {
            if (!confirm(`Are you sure you want to stop "${serverName}"?`)) return;
            try {
                const data = await apiCall(`/api/servers/${serverName}/stop`, { method: 'POST' });
                showNotification(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    loadActiveServers();
                    loadAllServers();
                }
            } catch (e) {
                showNotification('Error stopping server', 'error');
            }
        }

        async function restartServerFromDashboard(serverName) {
            if (!confirm(`Are you sure you want to restart "${serverName}"?`)) return;
            try {
                const stopData = await apiCall(`/api/servers/${serverName}/stop`, { method: 'POST' });
                if (stopData.success) {
                    setTimeout(async () => {
                        try {
                            const startData = await apiCall(`/api/servers/${serverName}/start`, { method: 'POST' });
                            showNotification(startData.message, startData.success ? 'success' : 'error');
                            loadActiveServers();
                            loadAllServers();
                        } catch (e) {
                            showNotification('Error restarting server', 'error');
                        }
                    }, 2000);
                } else {
                    showNotification(stopData.message, 'error');
                }
            } catch (e) {
                showNotification('Error restarting server', 'error');
            }
        }

        function updateSystemStats(stats) {
            const statCards = document.querySelectorAll('.stat-card');
            
            if (statCards[0]) {
                statCards[0].querySelector('.stat-value').textContent = stats.cpu_percent.toFixed(1) + '%';
                statCards[0].querySelector('.progress-fill').style.width = stats.cpu_percent + '%';
            }

            if (statCards[1]) {
                statCards[1].querySelector('.stat-value').textContent = stats.memory_percent.toFixed(1) + '%';
                statCards[1].querySelector('.progress-fill').style.width = stats.memory_percent + '%';
            }

            if (statCards[2]) {
                statCards[2].querySelector('.stat-value').textContent = stats.disk_percent.toFixed(1) + '%';
                statCards[2].querySelector('.progress-fill').style.width = stats.disk_percent + '%';
            }
        }

        // Load active servers
        async function loadActiveServers() {
            try {
                const data = await apiCall('/api/servers');
                const activeServers = data.filter(server => server.status === 'running');
                
                const container = document.getElementById('activeServers');
                
                if (activeServers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-server"></i>
                            <h3>No active servers</h3>
                            <p>Start a server to see it here</p>
                            <a href="/servers/new" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create Server
                            </a>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="server-grid">
                            ${activeServers.map(server => `
                                <div class="server-item">
                                    <div class="server-header">
                                        <div class="server-info">
                                            <h3>${server.name}</h3>
                                            <div class="server-meta">
                                                <span><i class="fas fa-plug"></i> Port: ${server.port}</span>
                                                <span><i class="fas fa-memory"></i> RAM: ${server.max_memory}</span>
                                            </div>
                                        </div>
                                        <div class="status-badge status-running">Running</div>
                                    </div>
                                    <div class="server-actions">
                                        <a href="/servers/${server.name}" class="btn btn-primary">
                                            <i class="fas fa-cog"></i> Manage
                                        </a>
                                        <button class="btn btn-danger" onclick="stopServer('${server.name}')">
                                            <i class="fas fa-stop"></i> Stop
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('activeServers').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="color: var(--danger-500);"></i>
                        <h3>Error loading active servers</h3>
                        <p>Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        async function stopServer(serverName) {
            if (!confirm(`Are you sure you want to stop "${serverName}"?`)) {
                return;
            }

            try {
                const data = await apiCall(`/api/servers/${serverName}/stop`, {
                    method: 'POST'
                });
                
                showNotification(data.message, data.success ? 'success' : 'error');
                
                if (data.success) {
                    loadActiveServers();
                    loadAllServers();
                }
            } catch (error) {
                showNotification('Error stopping server', 'error');
            }
        }

        function refreshStats() {
            loadSystemStats();
            loadActiveServers();
            loadAllServers();
            showNotification('Statistics refreshed', 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemStats();
            loadActiveServers();
            loadAllServers();
            
            // Version check
            async function checkUpdateBanner() {
                try {
                    const info = await apiCall('/api/version');
                    const banner = document.getElementById('updateBanner');
                    const cur = document.getElementById('currentVersionText');
                    const latest = document.getElementById('latestVersionText');
                    const link = document.getElementById('updateLink');
                    
                    if (info && info.success && info.update_available) {
                        if (cur) cur.textContent = info.version || '-';
                        if (latest) latest.textContent = info.latest || '-';
                        if (link && info.update_url) link.href = info.update_url;
                        banner.style.display = 'block';
                        
                        const dismiss = document.getElementById('dismissUpdate');
                        if (dismiss) dismiss.onclick = () => { banner.style.display = 'none'; };
                        
                        const updateBtn = document.getElementById('updateNowBtn');
                        if (updateBtn && !updateBtn._bound) {
                            let running = false;
                            updateBtn.onclick = async () => {
                                if (running) return;
                                running = true;
                                const prevHtml = updateBtn.innerHTML;
                                updateBtn.disabled = true;
                                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                                try {
                                    const res = await fetch('/api/system/update', { method: 'POST' });
                                    const data = await res.json();
                                    if (res.ok && data.success) {
                                        showNotification('Update completed. Please restart the app.', 'success');
                                    } else {
                                        showNotification(data.message || 'Update error', 'error');
                                    }
                                } catch (e) {
                                    showNotification('Update error: ' + (e?.message || e), 'error');
                                } finally {
                                    updateBtn.disabled = false;
                                    updateBtn.innerHTML = prevHtml;
                                    running = false;
                                }
                            };
                            updateBtn._bound = true;
                        }
                    } else if (banner) {
                        banner.style.display = 'none';
                    }
                } catch (e) {
                    // ignore errors
                }
            }

            checkUpdateBanner();
            setInterval(checkUpdateBanner, 300000);
            
            // Auto-refresh every 5 seconds
            setInterval(() => {
                loadSystemStats();
                loadActiveServers();
                loadAllServers();
            }, 5000);
        });
    </script>
</body>
</html>