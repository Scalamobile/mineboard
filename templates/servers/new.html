<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MineBoard - Crea Server</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-plus-circle"></i> Crea Nuovo Server</h1>
            <p>Crea un nuovo server Minecraft</p>
            <div class="theme-switcher">
                <input type="checkbox" id="theme-toggle">
                <label for="theme-toggle">
                    <i class="fas fa-moon"></i>
                    <i class="fas fa-sun"></i>
                </label>
            </div>
        </div>

        <!-- Navigazione -->
        <div style="margin-bottom: 30px;">
            <a href="/servers" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Torna alla Lista
            </a>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <!-- Form Creazione -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cog"></i>
                    <h2>Configurazione Server</h2>
                </div>
                
                <form id="createServerForm">
                    <div class="form-group">
                        <label for="serverName">Nome Server *</label>
                        <input type="text" id="serverName" name="name" required 
                               placeholder="es. survival-server" 
                               pattern="^[A-Za-z0-9_\-]+$"
                               title="Solo lettere, numeri, trattini e underscore">
                        <small style="color: #666;">Solo lettere, numeri, trattini e underscore</small>
                    </div>

                    <div class="form-group">
                        <label for="serverPort">Porta *</label>
                        <input type="number" id="serverPort" name="port" required 
                               value="25565" min="1024" max="65535">
                        <small style="color: #666;">Porta su cui il server ascolterà (1024-65535)</small>
                    </div>

                    <div class="form-group">
                        <label for="serverMemory">Memoria Massima (es. 2G, 1024M) *</label>
                        <input type="text" id="serverMemory" name="max_memory" required value="2G" placeholder="es. 2G">
                        <small style="color: #666;">Inserisci una quantità (es. 2G, 4096M)</small>
                    </div>

                    <div class="form-group">
                        <label for="jarFile">File JAR</label>
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <input type="text" id="jarFile" name="jar_file" 
                                   value="server.jar" placeholder="server.jar" style="flex: 1;">
                            <button type="button" class="btn btn-primary" onclick="showJarDownloader()">
                                <i class="fas fa-download"></i> Scarica JAR
                            </button>
                        </div>
                        <small style="color: #666;">Nome del file JAR del server o scarica automaticamente da CentroJars</small>
                    </div>

                    <div class="form-group">
                        <label for="platform">Piattaforma</label>
                        <select id="platform" name="platform">
                            <option value="minecraft" selected>Minecraft (Paper/Spigot/Vanilla/Folia etc.)</option>
                            <option value="velocity">Velocity (Proxy)</option>
                        </select>
                        <small style="color: #666;">Se scegli Velocity, verrà creato velocity.toml al posto di server.properties</small>
                    </div>

                    <div class="form-group">
                        <label for="serverMotd">MOTD (Message of the Day)</label>
                        <input type="text" id="serverMotd" name="motd" 
                               placeholder="Benvenuto nel mio server Minecraft!">
                        <small style="color: #666;">Messaggio mostrato nella lista server</small>
                    </div>

                    <div class="form-group">
                        <label for="serverDifficulty">Difficoltà</label>
                        <select id="serverDifficulty" name="difficulty">
                            <option value="easy">Facile</option>
                            <option value="normal" selected>Normale</option>
                            <option value="hard">Difficile</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="serverGamemode">Modalità di Gioco</label>
                        <select id="serverGamemode" name="gamemode">
                            <option value="survival" selected>Sopravvivenza</option>
                            <option value="creative">Creativa</option>
                            <option value="adventure">Avventura</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="maxPlayers">Giocatori Massimi</label>
                        <input type="number" id="maxPlayers" name="max_players" 
                               value="20" min="1" max="100">
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus"></i> Crea Server
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </form>
            </div>

            <!-- Informazioni -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i>
                    <h2>Informazioni</h2>
                </div>
                
                <div style="line-height: 1.6;">
                    <h3><i class="fas fa-lightbulb"></i> Suggerimenti</h3>
                    <ul style="margin: 15px 0; padding-left: 20px;">
                        <li>Scegli un nome descrittivo per il server</li>
                        <li>Usa porte diverse per server multipli</li>
                        <li>Alloca memoria in base alle risorse disponibili</li>
                        
                    </ul>

                    <h3><i class="fas fa-exclamation-triangle"></i> Note Importanti</h3>
                    <ul style="margin: 15px 0; padding-left: 20px;">
                        <li>Il server sarà creato nella directory <code>./servers/</code></li>
                        <li>Dovrai caricare manualmente il file JAR se non verrà scaricato tramite il pulsante "Scarica JAR"</li>
                        <li>La configurazione può essere modificata dopo</li>
                        <li>Assicurati che Java sia installato</li>
                    </ul>

                    <h3><i class="fas fa-download"></i> File JAR Consigliati</h3>
                    <ul style="margin: 15px 0; padding-left: 20px;">
                        <li><strong>Paper</strong> - Ottimizzato per performance</li>
                        <li><strong>Spigot</strong> - Con supporto plugin</li>
                        <li><strong>Vanilla</strong> - Server ufficiale Minecraft</li>
                        <li><strong>Fabric</strong> - Per mod moderne</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Download JAR -->
    <div id="jarDownloadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-download"></i> Download JAR from MCUtils</h2>
                <span class="close" onclick="closeJarDownloader()">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="jarCategory">Type</label>
                    <select id="jarCategory">
                        <option value="">Select type...</option>
                        <optgroup label="Servers">
                            <option value="purpur">Purpur</option>
                            <option value="pufferfish">Pufferfish</option>
                            <option value="paper">Paper</option>
                            <option value="vanilla">Vanilla</option>
                            <option value="folia">Folia</option>
                        </optgroup>
                        <optgroup label="Proxies">
                            <option value="velocity">Velocity</option>
                        </optgroup>
                        <optgroup label="Modded">
                            <option value="fabric">Fabric</option>
                            <option value="neoforge">NeoForge</option>
                            <option value="quilt">Quilt</option>
                            <option value="forge">Forge</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="jarVersion">Versione</label>
                    <input type="text" id="jarVersion" placeholder="es. 1.20.1, 1.19.4" value="">
                    <small style="color: #666;">Inserisci la versione specifica (es. 1.20.1)</small>
                </div>
                
                <div class="form-group">
                    <label for="jarFilename">Nome file</label>
                    <input type="text" id="jarFilename" value="server.jar" placeholder="server.jar">
                </div>
            </div>
            
            <div id="jarInfo" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
                <!-- Informazioni JAR -->
            </div>
            
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-success" onclick="downloadJar()">
                    <i class="fas fa-download"></i> Scarica JAR
                </button>
                <button class="btn btn-secondary" onclick="closeJarDownloader()">
                    <i class="fas fa-times"></i> Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- Notifiche -->
    <div id="notification"></div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
        // Variabile per tenere traccia della cartella temporanea
        let tempServerName = null;

        // Gestione form
        document.getElementById('createServerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // Validazione
            if (!data.name || !data.port || !data.max_memory) {
                showNotification('Compila tutti i campi obbligatori', 'error');
                return;
            }

            // Controlla se il nome contiene caratteri validi
            if (!/^[a-zA-Z0-9_-]+$/.test(data.name)) {
                showNotification('Il nome può contenere solo lettere, numeri, trattini e underscore', 'error');
                return;
            }

            try {
                // Se non c'è una cartella temporanea, creala
                if (!tempServerName) {
                    const tempResult = await apiCall('/api/servers/temp', {
                        method: 'POST'
                    });
                    
                    if (tempResult.success) {
                        tempServerName = tempResult.temp_name;
                        showNotification('Cartella temporanea creata', 'success');
                    } else {
                        showNotification('Errore nella creazione cartella temporanea: ' + tempResult.message, 'error');
                        return;
                    }
                }

                // Crea il server direttamente con il nome finale
                const result = await apiCall('/api/servers', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if (result.success) {
                    // Se c'è un JAR nella cartella temporanea, spostalo
                    if (tempServerName) {
                        try {
                            // Sposta il JAR dalla cartella temporanea a quella finale
                            const moveResult = await apiCall('/api/servers/move-jar', {
                                method: 'POST',
                                body: JSON.stringify({
                                    temp_name: tempServerName,
                                    final_name: data.name,
                                    jar_filename: data.jar_file
                                })
                            });
                            
                            if (moveResult.success) {
                                showNotification('Server creato con successo e JAR spostato!', 'success');
                            } else {
                                showNotification('Server creato ma errore nello spostamento JAR: ' + moveResult.message, 'warning');
                            }
                        } catch (error) {
                            showNotification('Server creato ma errore nello spostamento JAR: ' + error.message, 'warning');
                        }
                    } else {
                        showNotification('Server creato con successo!', 'success');
                    }
                    
                    // Redirect alla lista server dopo 2 secondi
                    setTimeout(() => {
                        window.location.href = '/servers';
                    }, 2000);
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Errore nella creazione del server: ' + error.message, 'error');
            }
        });

        function resetForm() {
            document.getElementById('createServerForm').reset();
            document.getElementById('serverPort').value = '25565';
            document.getElementById('serverMemory').value = '2G';
            document.getElementById('jarFile').value = 'server.jar';
            document.getElementById('maxPlayers').value = '20';
            showNotification('Form resettato', 'success');
        }

        // Auto-genera nome server
        document.getElementById('serverName').addEventListener('input', function() {
            const name = this.value.toLowerCase().replace(/[^a-z0-9_-]/g, '-');
            if (name !== this.value) {
                this.value = name;
            }
        });

        // Validazione versione in tempo reale
        document.getElementById('jarVersion').addEventListener('input', function() {
            const version = this.value.trim();
            if (version) {
                // Mostra suggerimento per versioni comuni
                if (version.match(/^\d+\.\d+$/)) {
                    this.style.borderColor = '#51cf66'; // Verde per formato valido
                } else if (version.match(/^\d+\.\d+\.\d+$/)) {
                    this.style.borderColor = '#51cf66'; // Verde per formato valido
                } else {
                    this.style.borderColor = '#ffd43b'; // Giallo per formato sospetto
                }
            } else {
                this.style.borderColor = '#e9ecef'; // Reset colore
            }
        });

        // Controlla porta disponibile
        document.getElementById('serverPort').addEventListener('change', async function() {
            const port = this.value;
            if (port < 1024 || port > 65535) {
                showNotification('La porta deve essere compresa tra 1024 e 65535', 'warning');
                return;
            }

            // Qui potresti aggiungere un controllo per verificare se la porta è già in uso
            // Per ora mostriamo solo un messaggio informativo
            showNotification(`Porta ${port} selezionata`, 'success');
        });

        // MCUtils types are presented directly in the select via optgroups

        function showJarDownloader() {
            document.getElementById('jarDownloadModal').style.display = 'block';
        }

        function closeJarDownloader() {
            document.getElementById('jarDownloadModal').style.display = 'none';
        }

        // No dynamic type/category loading required for MCUtils

        async function downloadJar() {
            const category = document.getElementById('jarCategory').value;
            const version = document.getElementById('jarVersion').value.trim();
            const filename = document.getElementById('jarFilename').value;
            
            if (!category) {
                showNotification('Select a JAR type', 'error');
                return;
            }
            
            if (!version) {
                showNotification('Inserisci una versione', 'error');
                return;
            }
            
            if (!filename) {
                showNotification('Inserisci un nome per il file JAR', 'error');
                return;
            }
            
            try {
                showNotification('Download JAR in corso...', 'success');

                // Se l'utente seleziona Velocity, imposta automaticamente la piattaforma su Velocity
                const platformSelect = document.getElementById('platform');
                if (category === 'velocity' && platformSelect) {
                    platformSelect.value = 'velocity';
                }
                
                // Crea cartella temporanea se non esiste
                if (!tempServerName) {
                    const tempResult = await apiCall('/api/servers/temp', {
                        method: 'POST'
                    });
                    
                    if (tempResult.success) {
                        tempServerName = tempResult.temp_name;
                    } else {
                        showNotification('Errore nella creazione cartella temporanea: ' + tempResult.message, 'error');
                        return;
                    }
                }
                
                // Scarica il JAR tramite proxy locale (per CORS) da MCUtils
                const response = await fetch(`/api/mcutils/download/${category}/${version}`);
                
                if (response.ok) {
                    // Salva il JAR nella cartella temporanea
                    const blob = await response.blob();
                    
                    // Converti blob in base64
                    const reader = new FileReader();
                    reader.onload = async function() {
                        const base64Data = reader.result.split(',')[1]; // Rimuovi il prefisso data:application/java-archive;base64,
                        
                        const uploadResult = await apiCall(`/api/files/${tempServerName}/upload-blob`, {
                            method: 'POST',
                            body: JSON.stringify({
                                filename: filename,
                                file_data: base64Data
                            })
                        });
                        
                        if (uploadResult.success) {
                            // Aggiorna il campo nome file nel form principale
                            document.getElementById('jarFile').value = filename;
                            
                            // Chiudi il modal
                            closeJarDownloader();
                            
                            showNotification(`JAR ${category} v${version} scaricato con successo!`, 'success');
                        } else {
                            showNotification('Errore nel salvataggio del JAR: ' + uploadResult.message, 'error');
                        }
                    };
                    reader.readAsDataURL(blob);
                } else {
                    showNotification(`Version ${version} not found for ${category}.`, 'error');
                }
            } catch (error) {
                showNotification('Error downloading JAR: ' + error.message, 'error');
            }
        }

        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            const modal = document.getElementById('jarDownloadModal');
            if (event.target === modal) {
                closeJarDownloader();
            }
        }
    </script>
</body>
</html>
